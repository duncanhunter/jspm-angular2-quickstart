System.register(['typescript', './logger', './utils', "./compiler-host"], function(exports_1) {
    var ts, logger_1, utils_1, compiler_host_1;
    var logger, TypeChecker;
    return {
        setters:[
            function (ts_1) {
                ts = ts_1;
            },
            function (logger_1_1) {
                logger_1 = logger_1_1;
            },
            function (utils_1_1) {
                utils_1 = utils_1_1;
            },
            function (compiler_host_1_1) {
                compiler_host_1 = compiler_host_1_1;
            }],
        execute: function() {
            logger = new logger_1.default({ debug: false });
            TypeChecker = (function () {
                function TypeChecker(host) {
                    this._host = host;
                    this._options = ts.clone(this._host.options);
                    this._options.inlineSourceMap = false;
                    this._options.sourceMap = false;
                    this._options.declaration = false;
                    this._options.isolatedModules = false;
                    this._options.skipDefaultLibCheck = true;
                }
                TypeChecker.prototype.check = function () {
                    var candidates = this.getCandidates();
                    if (candidates.some(function (candidate) { return candidate.checkable && !utils_1.isTypescriptDeclaration(candidate.name); }))
                        return this.getAllDiagnostics(candidates);
                    else
                        return [];
                };
                TypeChecker.prototype.forceCheck = function () {
                    var files = this._host.getAllFiles()
                        .filter(function (file) { return file.fileName != compiler_host_1.__HTML_MODULE__; });
                    var unchecked = files.filter(function (file) { return !file.checked; });
                    var errored = files.filter(function (file) { return file.checked && utils_1.hasError(file.errors); });
                    if ((errored.length > 0) || (unchecked.length > 0)) {
                        return [{
                                file: undefined,
                                start: undefined,
                                length: undefined,
                                code: 9999,
                                category: ts.DiagnosticCategory.Error,
                                messageText: "compilation failed [" + files.length + " files, " + errored.length + " failed, " + unchecked.length + " unchecked]"
                            }];
                    }
                    return [];
                };
                TypeChecker.prototype.getCandidates = function () {
                    var _this = this;
                    var candidates = this._host.getAllFiles()
                        .filter(function (file) { return file.fileName != compiler_host_1.__HTML_MODULE__; })
                        .map(function (file) { return ({
                        name: file.fileName,
                        file: file,
                        seen: false,
                        resolved: !!file.dependencies,
                        checkable: undefined,
                        deps: file.dependencies && file.dependencies.list
                    }); });
                    var candidatesMap = candidates.reduce(function (result, candidate) {
                        result[candidate.name] = candidate;
                        return result;
                    }, {});
                    candidates.forEach(function (candidate) { return candidate.checkable = _this.isCheckable(candidate, candidatesMap); });
                    return candidates;
                };
                TypeChecker.prototype.isCheckable = function (candidate, candidatesMap) {
                    var _this = this;
                    if (!candidate)
                        return false;
                    else {
                        if (!candidate.seen) {
                            candidate.seen = true;
                            candidate.checkable = candidate.resolved && candidate.deps.every(function (dep) { return _this.isCheckable(candidatesMap[dep], candidatesMap); });
                        }
                        return (candidate.checkable !== false);
                    }
                };
                TypeChecker.prototype.getAllDiagnostics = function (candidates) {
                    var filelist = candidates.map(function (dep) { return dep.name; }).concat([compiler_host_1.__HTML_MODULE__]);
                    var program = ts.createProgram(filelist, this._options, this._host);
                    return candidates.reduce(function (errors, candidate) {
                        if (candidate.checkable && !candidate.file.checked) {
                            candidate.file.errors = [];
                            if (!candidate.file.isLibFile) {
                                candidate.file.errors = program.getSyntacticDiagnostics(candidate.file)
                                    .concat(program.getSemanticDiagnostics(candidate.file));
                            }
                            candidate.file.checked = true;
                            return errors.concat(candidate.file.errors);
                        }
                        else {
                            return errors;
                        }
                    }, program.getGlobalDiagnostics());
                };
                return TypeChecker;
            })();
            exports_1("TypeChecker", TypeChecker);
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZS1jaGVja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3R5cGUtY2hlY2tlci50cyJdLCJuYW1lcyI6WyJUeXBlQ2hlY2tlciIsIlR5cGVDaGVja2VyLmNvbnN0cnVjdG9yIiwiVHlwZUNoZWNrZXIuY2hlY2siLCJUeXBlQ2hlY2tlci5mb3JjZUNoZWNrIiwiVHlwZUNoZWNrZXIuZ2V0Q2FuZGlkYXRlcyIsIlR5cGVDaGVja2VyLmlzQ2hlY2thYmxlIiwiVHlwZUNoZWNrZXIuZ2V0QWxsRGlhZ25vc3RpY3MiXSwibWFwcGluZ3MiOiI7O1FBT00sTUFBTTs7Ozs7Ozs7Ozs7Ozs7OztZQUFOLE1BQU0sR0FBRyxJQUFJLGdCQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQWE1QztnQkFJQ0EscUJBQVlBLElBQWtCQTtvQkFDN0JDLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBO29CQUVkQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFTQSxFQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtvQkFDeERBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLGVBQWVBLEdBQUdBLEtBQUtBLENBQUNBO29CQUN0Q0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7b0JBQ2hDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxXQUFXQSxHQUFHQSxLQUFLQSxDQUFDQTtvQkFDbENBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLGVBQWVBLEdBQUdBLEtBQUtBLENBQUNBO29CQUN0Q0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsbUJBQW1CQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDMUNBLENBQUNBO2dCQUtNRCwyQkFBS0EsR0FBWkE7b0JBQ0tFLElBQU1BLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBLGFB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QSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQTs0QkFDdEJBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO3dCQUNyREEsQ0FBQ0E7d0JBQ0tBLElBQUlBLENBQUNBLENBQUNBOzRCQUNIQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQTt3QkFDakJBLENBQUNBO29CQUNSQSxDQUFDQSxFQUFFQSxPQUFPQSxDQUFDQSxvQkFBb0JBLEVBQUVBLENBQUNBLENBQUNBO2dCQUNwQ0EsQ0FBQ0E7Z0JBQ0ZOLGtCQUFDQTtZQUFEQSxDQUFDQSxBQTdHRCxJQTZHQztZQTdHRCxxQ0E2R0MsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qICovXG5pbXBvcnQgKiBhcyB0cyBmcm9tICd0eXBlc2NyaXB0JztcbmltcG9ydCBMb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHtpc1R5cGVzY3JpcHREZWNsYXJhdGlvbiwgaGFzRXJyb3J9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHtDb21waWxlckhvc3QsIENvbWJpbmVkT3B0aW9ucywgU291cmNlRmlsZX0gZnJvbSAnLi9jb21waWxlci1ob3N0JztcbmltcG9ydCB7X19IVE1MX01PRFVMRV9ffSBmcm9tIFwiLi9jb21waWxlci1ob3N0XCI7XG5cbmNvbnN0IGxvZ2dlciA9IG5ldyBMb2dnZXIoeyBkZWJ1ZzogZmFsc2UgfSk7XG5cbnR5cGUgQ2FuZGlkYXRlID0ge1xuICAgbmFtZTogc3RyaW5nO1xuICAgZmlsZTogU291cmNlRmlsZTsgICBcbiAgIHNlZW46IGJvb2xlYW47XG4gICByZXNvbHZlZDogYm9vbGVhbjtcbiAgIGRlcHM6IHN0cmluZ1tdO1xuICAgY2hlY2thYmxlOiBib29sZWFuO1xufVxuXG50eXBlIENhbmRpZGF0ZU1hcCA9IHsgW3M6IHN0cmluZ106IENhbmRpZGF0ZSB9O1xuXG5leHBvcnQgY2xhc3MgVHlwZUNoZWNrZXIge1xuXHRwcml2YXRlIF9ob3N0OiBDb21waWxlckhvc3Q7XG4gICBwcml2YXRlIF9vcHRpb25zOiBDb21iaW5lZE9wdGlvbnM7XG5cblx0Y29uc3RydWN0b3IoaG9zdDogQ29tcGlsZXJIb3N0KSB7XG5cdFx0dGhpcy5faG9zdCA9IGhvc3Q7XG5cbiAgICAgIHRoaXMuX29wdGlvbnMgPSAoPGFueT50cykuY2xvbmUodGhpcy5faG9zdC5vcHRpb25zKTtcblx0XHR0aGlzLl9vcHRpb25zLmlubGluZVNvdXJjZU1hcCA9IGZhbHNlO1xuXHRcdHRoaXMuX29wdGlvbnMuc291cmNlTWFwID0gZmFsc2U7XG5cdFx0dGhpcy5fb3B0aW9ucy5kZWNsYXJhdGlvbiA9IGZhbHNlO1xuXHRcdHRoaXMuX29wdGlvbnMuaXNvbGF0ZWRNb2R1bGVzID0gZmFsc2U7XG5cdFx0dGhpcy5fb3B0aW9ucy5za2lwRGVmYXVsdExpYkNoZWNrID0gdHJ1ZTsgLy8gZG9uJ3QgY2hlY2sgdGhlIGRlZmF1bHQgbGliIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2Vcblx0fVxuXG5cdC8qXG5cdFx0cmV0dXJucyBhIHByb21pc2UgdG8gYW4gYXJyYXkgb2YgdHlwZXNjcmlwdCBlcnJvcnMgZm9yIHRoaXMgZmlsZVxuXHQqL1xuXHRwdWJsaWMgY2hlY2soKTogdHMuRGlhZ25vc3RpY1tdIHsgICAgICAgICBcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSB0aGlzLmdldENhbmRpZGF0ZXMoKTtcbiAgICAgIGlmIChjYW5kaWRhdGVzLnNvbWUoY2FuZGlkYXRlID0+IGNhbmRpZGF0ZS5jaGVja2FibGUgJiYgIWlzVHlwZXNjcmlwdERlY2xhcmF0aW9uKGNhbmRpZGF0ZS5uYW1lKSkpICAgICAgICAgICAgXG4gICAgICAgICByZXR1cm4gdGhpcy5nZXRBbGxEaWFnbm9zdGljcyhjYW5kaWRhdGVzKTsgXG4gICAgICBlbHNlXG4gICAgICAgICByZXR1cm4gW107XG5cdH1cblxuXHQvKlxuXHRcdHRocm93cyBpZiB0aGVyZSBhcmUgY29tcGlsZXIgZXJyb3JzIG9yIHVucmVzb2x2ZWQgZmlsZXNcblx0Ki9cblx0cHVibGljIGZvcmNlQ2hlY2soKTogdHMuRGlhZ25vc3RpY1tdIHtcbiAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5faG9zdC5nZXRBbGxGaWxlcygpXG4gICAgICAgICAuZmlsdGVyKGZpbGUgPT4gZmlsZS5maWxlTmFtZSAhPSBfX0hUTUxfTU9EVUxFX18pO1xuICAgICAgY29uc3QgdW5jaGVja2VkID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gIWZpbGUuY2hlY2tlZCk7XG4gICAgICBjb25zdCBlcnJvcmVkID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gZmlsZS5jaGVja2VkICYmIGhhc0Vycm9yKGZpbGUuZXJyb3JzKSk7XG4gICAgICBcbiAgICAgIGlmICgoZXJyb3JlZC5sZW5ndGggPiAwKSB8fCAodW5jaGVja2VkLmxlbmd0aCA+IDApKSB7XG4gICAgICAgICByZXR1cm4gW3tcbiAgICAgICAgICAgIGZpbGU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHN0YXJ0OiB1bmRlZmluZWQsXG4gICAgICAgICAgICBsZW5ndGg6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGNvZGU6IDk5OTksXG4gICAgICAgICAgICBjYXRlZ29yeTogdHMuRGlhZ25vc3RpY0NhdGVnb3J5LkVycm9yLFxuICAgICAgICAgICAgbWVzc2FnZVRleHQ6IGBjb21waWxhdGlvbiBmYWlsZWQgWyR7ZmlsZXMubGVuZ3RofSBmaWxlcywgJHtlcnJvcmVkLmxlbmd0aH0gZmFpbGVkLCAke3VuY2hlY2tlZC5sZW5ndGh9IHVuY2hlY2tlZF1gXG4gICAgICAgICB9XTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuIFtdOyBcblx0fVxuXG4gICBwcml2YXRlIGdldENhbmRpZGF0ZXMoKSB7XG4gICAgICBjb25zdCBjYW5kaWRhdGVzID0gdGhpcy5faG9zdC5nZXRBbGxGaWxlcygpXG4gICAgICAgICAuZmlsdGVyKGZpbGUgPT4gZmlsZS5maWxlTmFtZSAhPSBfX0hUTUxfTU9EVUxFX18pXG4gICAgICAgICAubWFwKGZpbGUgPT4gKHtcbiAgICAgICAgICAgIG5hbWU6IGZpbGUuZmlsZU5hbWUsXG4gICAgICAgICAgICBmaWxlOiBmaWxlLFxuICAgICAgICAgICAgc2VlbjogZmFsc2UsXG4gICAgICAgICAgICByZXNvbHZlZDogISFmaWxlLmRlcGVuZGVuY2llcyxcbiAgICAgICAgICAgIGNoZWNrYWJsZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgZGVwczogZmlsZS5kZXBlbmRlbmNpZXMgJiYgZmlsZS5kZXBlbmRlbmNpZXMubGlzdFxuICAgICAgICAgfSkpO1xuICAgICAgXG4gICAgICBjb25zdCBjYW5kaWRhdGVzTWFwID0gY2FuZGlkYXRlcy5yZWR1Y2UoKHJlc3VsdCwgY2FuZGlkYXRlKSA9PiB7XG4gICAgICAgICByZXN1bHRbY2FuZGlkYXRlLm5hbWVdID0gY2FuZGlkYXRlO1xuICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0sIHt9IGFzIENhbmRpZGF0ZU1hcCk7XG4gICAgICBcbiAgICAgIGNhbmRpZGF0ZXMuZm9yRWFjaChjYW5kaWRhdGUgPT4gY2FuZGlkYXRlLmNoZWNrYWJsZSA9IHRoaXMuaXNDaGVja2FibGUoY2FuZGlkYXRlLCBjYW5kaWRhdGVzTWFwKSk7XG4gICAgICByZXR1cm4gY2FuZGlkYXRlcztcbiAgIH1cbiAgIFxuICAgcHJpdmF0ZSBpc0NoZWNrYWJsZShjYW5kaWRhdGU6IENhbmRpZGF0ZSwgY2FuZGlkYXRlc01hcDogQ2FuZGlkYXRlTWFwKTogYm9vbGVhbiB7XG4gICAgICBpZiAoIWNhbmRpZGF0ZSlcbiAgICAgICAgIHJldHVybiBmYWxzZTsgICAgICBcbiAgICAgIGVsc2Uge1xuICAgICAgICAgaWYgKCFjYW5kaWRhdGUuc2Vlbikge1xuICAgICAgICAgICAgY2FuZGlkYXRlLnNlZW4gPSB0cnVlO1xuICAgICAgICAgICAgY2FuZGlkYXRlLmNoZWNrYWJsZSA9IGNhbmRpZGF0ZS5yZXNvbHZlZCAmJiBjYW5kaWRhdGUuZGVwcy5ldmVyeShkZXAgPT4gdGhpcy5pc0NoZWNrYWJsZShjYW5kaWRhdGVzTWFwW2RlcF0sIGNhbmRpZGF0ZXNNYXApKTsgICAgICAgICAgICBcbiAgICAgICAgIH1cbiAgICAgICAgIFxuICAgICAgICAgcmV0dXJuIChjYW5kaWRhdGUuY2hlY2thYmxlICE9PSBmYWxzZSk7IC8vIGhhbmRsZXMgY2lyY3VsYXIgZ3JhcGggYmVjYXVzZSBzZWVuID0gdHJ1ZSBidXQgY2hlY2thYmxlID0gdW5kZWZpZW5kXG4gICAgICB9XG4gICB9XG4gICBcblx0Lypcblx0XHRSZXR1cm5zIHRoZSBkaWFnbm9zdGljcyBmb3IgdGhpcyBmaWxlIGFuZCBhbnkgZmlsZXMgd2hpY2ggaXQgdXNlcy5cblx0XHRFYWNoIGZpbGUgaXMgb25seSBjaGVja2VkIG9uY2UuXG5cdCovXG5cdHByaXZhdGUgZ2V0QWxsRGlhZ25vc3RpY3MoY2FuZGlkYXRlczogQ2FuZGlkYXRlW10pOiB0cy5EaWFnbm9zdGljW10ge1xuXHRcdC8vIGhhY2sgdG8gc3VwcG9ydCBodG1sIGltcG9ydHNcbiAgICAgIGxldCBmaWxlbGlzdCA9IGNhbmRpZGF0ZXMubWFwKChkZXApID0+IGRlcC5uYW1lKS5jb25jYXQoW19fSFRNTF9NT0RVTEVfX10pO1xuXHRcdGxldCBwcm9ncmFtID0gdHMuY3JlYXRlUHJvZ3JhbShmaWxlbGlzdCwgdGhpcy5fb3B0aW9ucywgdGhpcy5faG9zdCk7XG5cblx0XHRyZXR1cm4gY2FuZGlkYXRlcy5yZWR1Y2UoKGVycm9ycywgY2FuZGlkYXRlKSA9PiB7XG5cdFx0XHRpZiAoY2FuZGlkYXRlLmNoZWNrYWJsZSAmJiAhY2FuZGlkYXRlLmZpbGUuY2hlY2tlZCkge1xuICAgICAgICAgICAgY2FuZGlkYXRlLmZpbGUuZXJyb3JzID0gW107XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghY2FuZGlkYXRlLmZpbGUuaXNMaWJGaWxlKSB7XG4gICAgICAgICAgICAgICBjYW5kaWRhdGUuZmlsZS5lcnJvcnMgPSBwcm9ncmFtLmdldFN5bnRhY3RpY0RpYWdub3N0aWNzKGNhbmRpZGF0ZS5maWxlKVxuICAgICAgICAgICAgICAgICAgLmNvbmNhdChwcm9ncmFtLmdldFNlbWFudGljRGlhZ25vc3RpY3MoY2FuZGlkYXRlLmZpbGUpKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuXHRcdFx0XHRjYW5kaWRhdGUuZmlsZS5jaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIHJldHVybiBlcnJvcnMuY29uY2F0KGNhbmRpZGF0ZS5maWxlLmVycm9ycyk7XG5cdFx0XHR9XG4gICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBlcnJvcnM7XG4gICAgICAgICB9ICAgICAgICBcdFx0XHRcblx0XHR9LCBwcm9ncmFtLmdldEdsb2JhbERpYWdub3N0aWNzKCkpO1xuXHR9XG59Il19